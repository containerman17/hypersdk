<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>
    <script>
        const sdk = new MetaMaskSDK.MetaMaskSDK({
            dappMetadata: {
                name: "Pure JS example",
                url: window.location.host,
            },
            logging: {
                sdk: false,
            }
        });
    </script>
    <script>
        let provider;

        function connect() {
            return sdk.connect()
                .then((res) => {
                    provider = sdk.getProvider();
                })
                .catch((e) => console.log('request accounts ERR', e));
        }

        async function signStructuredTailored() {
            await connect();

            const toGoStyleIsoString = (date) => {
                return date.toISOString().slice(0, -5) + 'Z'
            }

            const chainId = await provider.request({ method: 'eth_chainId' });
            // eth_signTypedData_v4 parameters. All of these parameters affect the resulting signature.
            const msgParams = JSON.stringify({
                domain: {
                    chainId: 43114,
                    name: 'HyperSDK',
                    verifyingContract: '0x0000000000000000000000000000000000000000',
                    version: '1',
                },

                // This defines the message you're proposing the user to sign, is dapp-specific, and contains
                // anything you want. There are no required fields. Be as explicit as possible when building out
                // the message schema.
                message: {
                    expiration: toGoStyleIsoString(new Date(1717111222333)),
                    maxFee: '10.000000000',
                    action: "Transfer",
                    params:
                    {
                        to: 'morpheus1qypqxpq9qcrsszg2pvxq6rs0zqqqqqqqqqqqqqqqqqqqqqqqqqqqql22w7h',
                        value: '123.000000000',
                    },
                },
                // This refers to the keys of the following types object.
                primaryType: "Transaction",
                types: {
                    EIP712Domain: [
                        { name: 'name', type: 'string' },
                        { name: 'version', type: 'string' },
                        { name: 'chainId', type: 'uint256' },
                        { name: 'verifyingContract', type: 'address' },
                    ],
                    "Transaction": [
                        { name: "expiration", type: "string" },
                        { name: "maxFee", type: "string" },
                        { name: "action", type: "string" },
                        { name: "params", type: "Params" },
                    ],
                    "Params": [
                        { name: "to", type: "string", },
                        { name: "value", type: "string" },
                    ]
                },
            });


            const accounts = await provider.request({ method: 'eth_requestAccounts' });

            var params = [accounts[0], msgParams];
            var method = "eth_signTypedData_v4";
            console.log("Using account: ", accounts[0])

            await provider // Or window.ethereum if you don't support EIP-6963.
                .sendAsync(
                    {
                        method,
                        params,
                        from: accounts[0],
                    },
                    function (err, result) {
                        if (err) return console.dir(err);
                        if (result.error) {
                            alert(result.error.message);
                        }
                        if (result.error) return console.error("ERROR", result);
                        console.log("TYPED SIGNED:" + JSON.stringify(result.result));


                    }
                );
        }
    </script>
    <button onclick="signStructuredTailored()">SIGN STRUCTURED: tailored</button>
</body>

</html>